/*! calendar tianxiangbing http://www.lovewebgames.com/jsmodule/calendar.html 2015-03-20 */
function Calendar(){this.monthArr=["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],this.dayArr=["日","一","二","三","四","五","六"];var a=Math.random().toString().replace(".","");this.id="calendar_"+a,this.calendarContainer,this.settings={},this.isShow=!1,this.autohide=!0,this.toolbarTpl='<div class="ui-calendar-toolbar clearfix"><a class="js-calendar-submit">确定</a><a class="js-clear">清空</a><a class="ui-calendar-close">关闭</a></div>',this.dateArr=[],this.maxDays=9999}Calendar.prototype={separator:"-",defaultDate:new Date,setRange:function(a){this.range=$.extend([null,null],a)},init:function(a){$("body").append('<div class="ui-calendar clearfix" id="'+this.id+'"><div class="ui-calendar-pannel clearfix" data-role="pannel"><span class="ui-calendar-control" data-role="prev-year">&lt;&lt;</span><span class="ui-calendar-control" data-role="prev-month">&lt;</span><span class="ui-calendar-control month" data-role="current-month"></span><span class="ui-calendar-control year" data-role="current-year"></span><span class="ui-calendar-control" data-role="next-month">&gt;</span><span class="ui-calendar-control" data-role="next-year">&gt;&gt;</span></div><div class="calendar-header clearfix"></div><div class="c_days clearfix"></div></div>'),this.calendarContainer=$("#"+this.id);var b=this;if(this.settings=$.extend({},this.settings,a),this.maxDays=this.settings.maxdays||this.maxDays,this.settings.target&&$(this.settings.target).size()&&(this.settings.focusDate=1===$(this.settings.target)[0].nodeType?this.settings.focusDate||$(this.settings.target).val():this.settings.focusDate||$(this.settings.target).prev().val()||""),this.settings.focusDate&&!this.settings.multiple){var c=this.settings.focusDate.split(this.separator);this.defaultDate=new Date(c[0],parseInt(c[1])-1,c[2])}if(this.settings.focusDate&&this.settings.multiple){for(var d=this.settings.focusDate.split(","),e=d.length-1;e>=0;e--){var f=d[e],c=f.split(this.separator);this.dateArr.push(new Date(c[0],parseInt(c[1])-1,c[2]))}this.defaultDate=this.dateArr[0],b._dateInArr(b.defaultDate,b.dateArr)||b.dateArr.push(b.date)}this.settings.multiple&&(this.settings.toolbar=!0),this.settings.toolbar&&(this.autohide=!1);var g=this.settings.zIndex||1;this.calendarContainer.css("zIndex",g),this.date=this.defaultDate,this.setRange(this.settings.range),this.showToolbar(),this.formatDate(),this.renderHeader(),this.bindEvent(),this.settings.target?this.hide():(this.autohide=!1,this.show())},showToolbar:function(){this.settings.toolbar&&this.calendarContainer.append(this.toolbarTpl)},show:function(){this.calendarContainer.show(),this.isShow=!0,this.setPosition(),this.settings.show&&this.settings.show(this.calendarContainer)},hide:function(){this.calendarContainer.hide(),this.isShow=!1,this.settings.hide&&this.settings.hide(this.calendarContainer)},setPosition:function(){var a=0,b=0;this.settings.target&&$(this.settings.target).size()&&(1===$(this.settings.target)[0].nodeType?(b=$(this.settings.target).offset().top+$(this.settings.target).outerHeight(),a=$(this.settings.target).offset().left):(b=$(this.settings.target).prev().offset().top+$(this.settings.target).prev().outerHeight(),a=$(this.settings.target).prev().offset().left),this.calendarContainer.css({top:b,left:a}))},bindEvent:function(){var a=this;$(".ui-calendar-control[data-role]",a.calendarContainer).click(function(){return a.go[$(this).data("role")].call(a),!1}),$(a.calendarContainer).click(function(){return!1}),$(".c_days",a.calendarContainer).delegate("li","click",function(){if(a.settings.beforeSelect&&a.settings.beforeSelect(a.date,a.calendarContainer),$(this).hasClass("disabled"))return!1;var b=$(this).data("value"),c=b.split(a.separator);if(a.defaultDate=new Date(c[0],parseInt(c[1])-1,c[2]),a.date=a.defaultDate,a.settings.multiple)if($(this).hasClass("focus"))a._removeDate(a.defaultDate,a.dateArr);else{if(a.maxDays<=a.dateArr.length)return a.settings.overdays&&a.settings.overdays(a.maxDays,a.dateArr,a.calendarContainer),!1;a.dateArr.push(a.defaultDate)}else a.dateArr=[a.date];return a.formatDate(),a.renderHeader(),a.settings.selected&&a.settings.selected(a.date,a.calendarContainer),a.settings.target&&$(a.settings.target).size()&&1===$(a.settings.target)[0].nodeType&&a.autohide&&($(a.settings.target).val(b),a.hide()),!1}),$(".ui-calendar-toolbar",a.calendarContainer).delegate("a","click",function(){if($(this).hasClass("js-calendar-submit")){a.settings.selected&&a.settings.selected(a.dateArr,a.calendarContainer);var b=a._toString(a.dateArr);value=b.join(","),$(a.settings.target).val(value),a.hide()}$(this).hasClass("ui-calendar-close")&&a.hide(),$(this).hasClass("js-clear")&&(a.dateArr=[],$(a.settings.target).val(""),a.formatDate())}),a.settings.target&&($(a.settings.target).bind("click",function(){return $(document).trigger("click"),a.show(),!1}),$(document).click(function(){a.isShow&&a.hide()}))},go:{"next-month":function(){this.month+=1,this._getDate(),this.formatDate(),this.renderHeader()},"prev-month":function(){this.month-=1,this.changeDate()},"next-year":function(){this.year+=1,this.changeDate()},"prev-year":function(){this.year-=1,this.changeDate()}},changeDate:function(){this._getDate(),this.formatDate(),this.renderHeader()},renderHeader:function(){$('[data-role="current-month"]',this.calendarContainer).html(this.monthArr[this.month]),$('[data-role="current-year"]',this.calendarContainer).html(this.year);for(var a="",b=0,c=this.dayArr.length;c>b;b++)a+="<b>"+this.dayArr[b]+"</b>";$(".calendar-header",this.calendarContainer).html(a)},_getDate:function(){this.date=new Date(this.year,this.month,this.day)},formatDate:function(){var a=this.date;this.year=a.getFullYear(),this.month=a.getMonth(),this.day=a.getDate();var b=new Date(this.year,this.month+1,0),c=b.getDate(),d="<ul>",e=new Date(this.year,this.month,1).getDay(),f=new Date(this.year,this.month,0),g=f.getDate(),h=new Date(this.year,this.month+2,0);e>0&&(d+=this._getDay(g-e+1,g,"preday",f)),d+=this._getDay(1,c,"",this.date);var i=new Date(this.year,this.month,c).getDay();d+=this._getDay(1,6-i,"nextday",h),d+="</ul>",$("#"+this.id).find(".c_days").html(d)},_toString:function(a){for(var b=[],c=a.length,d=0;c>d;d++){var e=a[d];"string"==typeof e&&(a[d]=new Date(e));for(var f=0;d>f;f++)if(e.getTime()<a[f]){var g=a[d];a[d]=a[f],a[f]=g}}for(var d=0,h=a.length;h>d;d++){var i=a[d],j=i.getFullYear(),k=this._getTowNum(i.getMonth()+1),l=this._getTowNum(i.getDate());b.push(j+this.separator+k+this.separator+l)}return b},_getDay:function(a,b,c,d){var e="",f=this.range[0],g=this.range[1];f&&(f=Date.parse(f)),g&&(g=Date.parse(g));for(var h=a;b>=h;h++){var i=c||"",j=d.getFullYear()+this.separator+this._getTowNum(d.getMonth()+1)+this.separator;j+=this._getTowNum(h);var k=new Date(d.getFullYear(),d.getMonth(),h),l=k.getTime();this.settings.multiple?this._dateInArr(k,this.dateArr)&&(i+=" focus"):l==this.defaultDate.getTime()&&(i+=" focus"),(f&&f>l||g&&l>g)&&(i+=" disabled"),e+='<li class="'+i+'" data-value="'+j+'">'+h+"</li>"}return e},_dateInArr:function(a,b){for(var c=b.length-1;c>=0;c--){var d=b[c],e=d;if("string"==typeof d){var f=d.split(this.separator);e=new Date(f[0],parseInt(f[1])-1,f[2])}if(a.getTime()==e.getTime())return!0}},_removeDate:function(a,b){for(var c=[],d=b.length-1;d>=0;d--){var e=b[d],f=e;if("string"==typeof e){var g=e.split(this.separator);f=new Date(g[0],parseInt(g[1])-1,g[2])}a.getTime()!=f.getTime()&&c.push(f)}this.dateArr=c},_getTowNum:function(a){return("0"+a.toString()).substr(-2)}};